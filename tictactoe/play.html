<html>
  <head>
    <link rel="stylesheet" href="./style.css">
    <title>Tic Tac Toe</title>
  </head>
  <body>
    <script>

      function random_number_gen() {
    return Math.floor(Math.random() * 9999);
  }
    </script>
    <script type="module">
      var game_state = "";

      const searchParams = new URLSearchParams(window.location.search);
      var gameId = searchParams.get('game_id');
      if (gameId == "new") {
        game_state = "new";
        gameId = random_number_gen();
        document.getElementById("game_id").innerHTML = gameId;
      }
      else {
        document.getElementById("game_id").innerHTML = gameId;
      }
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { getDatabase, set, ref, onValue, get,child } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDkf2Xme8vIYwSjNgpikMPlHETkteqEsfI",
    authDomain: "tic-tac-toe-online-108ca.firebaseapp.com",
    databaseURL: "https://tic-tac-toe-online-108ca-default-rtdb.firebaseio.com",
    projectId: "tic-tac-toe-online-108ca",
    storageBucket: "tic-tac-toe-online-108ca.appspot.com",
    messagingSenderId: "971654471519",
    appId: "1:971654471519:web:3e05a829c5db81a4f920ea"
  };

  // Initialize Firebase
  var player_1_exist = ""
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase();
  const dbRef = ref(getDatabase());
  function display_opponent(a,b) {
    document.getElementById("opponent_id").innerHTML = a;
    document.getElementById("user_turn").innerHTML += "(" + b + ")";
  }
  function add_players(a,b) {
    console.log(a);
    console.log(b);
    set(ref(database, '/games/' + gameId), {
    player_1: a,
    player_2: b,
    });
  }

  onAuthStateChanged(auth, (user) => {
  if (user) {
    // User is signed in, see docs for a list of available properties
    // https://firebase.google.com/docs/reference/js/auth.user
    var playerId = user.uid;
    console.log(playerId);
    console.log("User is signed in");
      // const gamesRef = ref(database, 'games/');
    // get(child(dbRef, "games/" + gameId)).then((snapshot) => {

    // });

    if (game_state == "new") {
    set(ref(database, '/games/' + gameId), {
    player_1: playerId,
    });
    const gamesRef = ref(database, 'games/' + gameId);
    onValue(gamesRef, (snapshot) => {
      var data = snapshot.val();
      var opponentId = data['player_2'];
      display_opponent(opponentId,playerId);
      
  });
      
    }
    else {
    get(child(dbRef, '/games/' + gameId)).then((snapshot) => {
      var existing_data = snapshot.val();
      console.log(existing_data);
      player_1_exist = existing_data['player_1'];
      add_players(player_1_exist,playerId);
      display_opponent(player_1_exist,player_1_exist);
    });  
    

        
  }
    console.log(playerId);
    document.getElementById("user_id").innerHTML = playerId;
    
    // ...
  } else {
    console.log("User is signed out");
    // User is signed out
    // ...
  }
});


setPersistence(auth, browserSessionPersistence)
  .then(() => {
    // Existing and future Auth states are now persisted in the current
    // session only. Closing the window would clear any existing state even
    // if a user forgets to sign out.
    // ...
    // New sign-in will be persisted with session persistence.
    return signInAnonymously(auth);
  })
  .catch((error) => {
    // Handle Errors here.
    const errorCode = error.code;
    const errorMessage = error.message;
  });

  function move_multi(a) {
    
    
  }
    </script>
    
    <script type="text/javascript" src="./script-multiplayer.js" type="text/javascript"></script>
    

  

  <!-- Header -->
  <header class="row">
    <div class="column">
      <h4>Jossaya Camille</h4>
    </div>
    <div class="column navbar">
      <a href="/">Home</a>
      <a href="/portfolio">Portfolio</a>
    </div>
</header>

  
<h1>Tic Tac Toe Online</h1>
<p>Your username: </p>
<p id="user_id"></p>

<p>Your opponent: </p>
<p id="opponent_id"></p>

<p>Game ID: </p>
<p id="game_id"></p>

<p id="user_turn">X goes first</p>
<table>
 
  <tr>
    <td width="33.3%">
      <button class="box" id="button_1" onclick="move_multi(1)">1</button>
    </td>
    <td width="33.3%">
      <button class="box" id="button_2" onclick="move_multi(2)">2</button>
    </td>
    <td width="33.3%">
      <button class="box" id="button_3" onclick="move_multi(3)">3</button>
    </td>
  </tr>
  <tr>
    <td width="33.3%">
      <button class="box" id="button_4" onclick="move_multi(4)">4</button>
    </td>
    <td width="33.3%">
      <button class="box" id="button_5" onclick="move_multi(5)">5</button>
    </td>
    <td width="33.3%">
      <button class="box" id="button_6" onclick="move_multi(6)">6</button>
    </td>
  </tr>
  <tr>
    <td width="33.3%">
      <button class="box" id="button_7" onclick="move_multi(7)">7</button>
    </td>
    <td width="33.3%">
      <button class="box" id="button_8" onclick="move_multi(8)">8</button>
    </td>
    <td width="33.3%">
      <button class="box" id="button_9" onclick="move_multi(9)">9</button>
    </td>
  </tr>
</table>
  <p id="game_winner"></p>
  <button style="display: none" onclick="play_again()" id="play_again">Play again?</button>

    
  </body>
</html>




    

